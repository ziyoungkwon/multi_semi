<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Virtual Trip</title>

    <style>

    </style>

</head>
<body>

<div th:fragment="header">

    <h1>Virtual Trip</h1>
    <nav>
        <a th:href="@{/}">í™ˆ</a>

        <span id="user-email-display" style="display: none; margin-right: 15px; font-weight: bold;"></span>

        <div class="vt-header-top">
            <a href="#" class="logo">
                <!--<img th:src="@{/img/VTlogo.png}" alt="Virtual Trip ë¡œê³ ">-->
            </a>

            <div class="search-wrapper">
                <button class="category-btn" aria-label="ì¹´í…Œê³ ë¦¬ ì„ íƒ">â–½</button>
                <input type="text" class="search-input" placeholder="ì—¬í–‰ì§€ë¥¼ ê²€ìƒ‰í•´ ë³´ì„¸ìš”">
                <button class="search-icon-btn" aria-label="ê²€ìƒ‰">ğŸ”</button>
            </div>

            <a th:href="@{/auth/login}" id="global-login-link">ë¡œê·¸ì¸</a>
            <button type="button" id="logout-btn" style="cursor: pointer;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <nav class="vt-nav">
            <a href="#" class="nav-item">ê´€ê´‘ì§€ ëª©ë¡</a>
            <a href="#" class="nav-item">ë¦¬ë·°</a>
            <a href="#" class="nav-item">ì´ë¯¸ì§€ ë§Œë“¤ê¸°</a>
            <a href="#" class="nav-item">ë§ˆì´í˜ì´ì§€</a>
        </nav>
    </nav>


    <script>
        // (ì‚¬ìš©ì ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ 2 - fetch ë˜í•‘ - ìˆ˜ì • X)

        // 1. ê¸°ì¡´ì˜ window.fetch í•¨ìˆ˜ë¥¼ ë°±ì—…í•´ë‘¡ë‹ˆë‹¤.
        const originalFetch = window.fetch;

        // ê°•ì œ ë¡œê·¸ì•„ì›ƒ í—¬í¼ í•¨ìˆ˜
        function forceLogout(message) {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('redirectUrl');
            alert(message || 'ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
            window.location.href = '/auth/login';
        }

        // 'ìë°œì /ê°•ì œ' ë¡œê·¸ì¸ì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
        function redirectToLogin() {
            if (window.location.pathname !== '/auth/login') {
                const fullRedirectUrl = window.location.pathname + window.location.search;
                console.log('401 ê°ì§€! ë¦¬ë””ë ‰ì…˜ URL ì €ì¥:', fullRedirectUrl);
                localStorage.setItem('redirectUrl', fullRedirectUrl);
            }
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            window.location.href = '/auth/login';
        }

        /**
         * ìë™ í† í° ê°±ì‹ (Silent Refresh) í—¬í¼ í•¨ìˆ˜
         * (HttpOnly ì¿ í‚¤ ë°©ì‹)
         */
        async function handleTokenRefresh() {
            const accessToken = localStorage.getItem('accessToken');

            if (!accessToken) {
                console.log('Access Tokenì´ ì—†ì–´ ê°±ì‹  ë¶ˆê°€.');
                return false;
            }

            try {
                // /auth/refresh ìš”ì²­
                // ë¸Œë¼ìš°ì €ê°€ HttpOnly ì¿ í‚¤(RT)ë¥¼ ìë™ìœ¼ë¡œ ì‹¤ì–´ ë³´ëƒ…ë‹ˆë‹¤.
                const refreshResponse = await originalFetch('/auth/refresh', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}` // ë§Œë£Œëœ AT
                    }
                    // credentials: 'include'ëŠ” ì•„ë˜ ì „ì—­ fetchì—ì„œ ìë™ ì¶”ê°€ë¨
                });

                if (refreshResponse.ok) {
                    const result = await refreshResponse.json();
                    const newAccessToken = result.data.accessToken;
                    localStorage.setItem('accessToken', newAccessToken);

                    console.log('í† í° ê°±ì‹  ì„±ê³µ (ìƒˆ AT ë°œê¸‰)');
                    return true; // ê°±ì‹  ì„±ê³µ
                } else {
                    const errorBody = await refreshResponse.json();
                    console.error('Refresh Token ê°±ì‹  ì‹¤íŒ¨ (ì¿ í‚¤ ë§Œë£Œ ë˜ëŠ” ë¬´íš¨):', errorBody.message);
                    return false; // ê°±ì‹  ì‹¤íŒ¨
                }

            } catch (error) {
                console.error('í† í° ê°±ì‹  ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                return false; // ê°±ì‹  ì‹¤íŒ¨
            }
        }


        // 2. window.fetch í•¨ìˆ˜ ë®ì–´ì“°ê¸°
        window.fetch = async (...args) => {

            let options = args[1] || {};
            const url = args[0];

            // ëª¨ë“  fetch ìš”ì²­ì— credentials: 'include'ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
            options.credentials = options.credentials || 'include';

            // 3. [ì—­í•  1] í† í° ìë™ ì£¼ì…
            if (url !== '/auth/login' && url !== '/auth/signup' && !url.startsWith('/auth/refresh')) {
                const accessToken = localStorage.getItem('accessToken');
                if (accessToken) {
                    options.headers = options.headers || {};
                    options.headers['Authorization'] = `Bearer ${accessToken}`;
                }
            }

            // 4. ì›ë³¸ fetch í•¨ìˆ˜ë¡œ ì‹¤ì œ ìš”ì²­ì„ ë³´ëƒ„
            const response = await originalFetch(url, options);

            // 5. [ì—­í•  2] 401 ì—ëŸ¬ ê°ì§€
            if (response.status === 401) {

                if (url.startsWith('/auth/refresh')) {
                    console.warn('/auth/refresh ìš”ì²­ ì‹¤íŒ¨ (RT ì¿ í‚¤ ë§Œë£Œ). ê°•ì œ ë¡œê·¸ì•„ì›ƒ.');
                    forceLogout('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
                    return new Promise(() => {});
                }

                const clonedResponse = response.clone();

                try {
                    const errorBody = await clonedResponse.json();

                    if (errorBody.message === "ë§Œë£Œëœ JWT í† í°ì…ë‹ˆë‹¤.") {
                        console.log("Access Token ë§Œë£Œ. ìë™ ê°±ì‹  ì‹œë„...");

                        const refreshSuccess = await handleTokenRefresh();

                        if (refreshSuccess) {
                            console.log("í† í° ê°±ì‹  ì„±ê³µ. ì›ë˜ ìš”ì²­ ì¬ì‹œë„.");
                            options.headers['Authorization'] = `Bearer ${localStorage.getItem('accessToken')}`;
                            return await originalFetch(url, options);
                        } else {
                            forceLogout('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.');
                            return new Promise(() => {});
                        }
                    }
                    else {
                        console.warn(`ê¸°íƒ€ 401 ì—ëŸ¬ (${errorBody.message}). ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ.`);
                        redirectToLogin();
                        return new Promise(() => {});
                    }

                } catch (e) {
                    console.error("401 ì‘ë‹µì´ ì˜ˆìƒëœ JSON í˜•ì‹ì´ ì•„ë‹˜.", e);
                    redirectToLogin();
                    return new Promise(() => {});
                }
            }

            // 10. 401ì´ ì•„ë‹ˆë©´, ì›ë˜ ì‘ë‹µì„ ê·¸ëŒ€ë¡œ ë°˜í™˜
            return response;
        };
    </script>


    <script>
        // (ì‚¬ìš©ì ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ 3 - ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ - ìˆ˜ì • X)
        const logoutButton = document.getElementById('logout-btn');
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {

                // "ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" í™•ì¸ì°½
                if (window.confirm("ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {

                    const accessToken = localStorage.getItem('accessToken');
                    if (!accessToken) {
                        alert('ì´ë¯¸ ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤.');
                        return;
                    }
                    try {
                        // ì„œë²„ëŠ” ì´ ìš”ì²­ì„ ë°›ê³  RT ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ëŠ” ì‘ë‹µì„ ë³´ëƒ„
                        const response = await originalFetch('/auth/logout', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });
                        if (response.ok) {
                            console.log('ì„œë²„ Refresh Token ì‚­ì œ ì™„ë£Œ (ì¿ í‚¤ í¬í•¨)');
                        } else {
                            console.error('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì‹¤íŒ¨');
                        }
                    } catch (error) {
                        console.error('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    } finally {
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('redirectUrl');
                        alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                        window.location.href = '/';
                    }

                } // if (window.confirm...) ë‹«ëŠ” ê´„í˜¸
            });
        }
    </script>


    <script>
        // (ì‚¬ìš©ì ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ 4 - JWT íŒŒì‹± ë° UI ì œì–´ - ìˆ˜ì • X)

        /**
         * [ â˜…â˜…â˜… ì‹ ê·œ í—¬í¼ í•¨ìˆ˜ â˜…â˜…â˜… ]
         * Access Token(JWT)ì˜ í˜ì´ë¡œë“œë¥¼ ë””ì½”ë”©í•˜ì—¬ JSON ê°ì²´ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤.
         * (ì„œë²„ì˜ TokenProvider.parseClaimsì™€ ë™ì¼í•œ ì—­í• )
         */
        function parseJwtPayload(token) {
            try {
                const base64Url = token.split('.')[1]; // í˜ì´ë¡œë“œ ë¶€ë¶„
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); // Base64Url -> Base64

                // Base64 ë””ì½”ë”© (UTF-8 ë¬¸ìì—´ì„ ì•ˆì „í•˜ê²Œ ë””ì½”ë”©)
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("JWT í˜ì´ë¡œë“œ ë””ì½”ë”© ì‹¤íŒ¨", e);
                return null;
            }
        }


        // DOMì´ ëª¨ë‘ ë¡œë“œëœ í›„ì— ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {

            // --- [ìŠ¤í¬ë¦½íŠ¸ 4] UI ì œì–´ ë¡œì§ (â˜…ì´ë©”ì¼ í‘œì‹œ ê¸°ëŠ¥ ì¶”ê°€â˜…) ---
            const accessToken = localStorage.getItem('accessToken');
            const loginLink = document.getElementById('global-login-link');
            const logoutButton = document.getElementById('logout-btn');
            const emailDisplay = document.getElementById('user-email-display'); // [ì‹ ê·œ]

            if (loginLink && logoutButton && emailDisplay) {
                if (accessToken) {
                    // === ë¡œê·¸ì¸í•œ ìƒíƒœ ===
                    loginLink.style.display = 'none';
                    logoutButton.style.display = 'inline-block';

                    // [ â˜…â˜…â˜… ì‹ ê·œ â˜…â˜…â˜… ]
                    // 1. ATë¥¼ ë””ì½”ë”©í•´ì„œ í˜ì´ë¡œë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    const payload = parseJwtPayload(accessToken);
                    if (payload) {
                        // 2. 'sub' í´ë ˆì„(ì´ë©”ì¼)ì„ <span>ì— í‘œì‹œí•©ë‹ˆë‹¤.
                        emailDisplay.textContent = payload.sub + " ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!";
                        emailDisplay.style.display = 'inline-block';
                    }

                } else {
                    // === ë¡œê·¸ì•„ì›ƒí•œ ìƒíƒœ ===
                    loginLink.style.display = 'inline-block';
                    logoutButton.style.display = 'none';
                    emailDisplay.style.display = 'none'; // [ì‹ ê·œ] ì´ë©”ì¼ ìˆ¨ê¹€
                }
            }

            // --- [ìŠ¤í¬ë¦½íŠ¸ 3] ìë°œì  ë¡œê·¸ì¸ ë§í¬ í´ë¦­ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼) ---
            if (loginLink) {
                loginLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    const currentUrl = window.location.pathname + window.location.search;
                    if (window.location.pathname !== '/auth/login') {
                        console.log('ë¡œê·¸ì¸ ë§í¬ í´ë¦­! ë¦¬ë””ë ‰ì…˜ URL ì €ì¥:', currentUrl);
                        localStorage.setItem('redirectUrl', currentUrl);
                    }
                    window.location.href = loginLink.href;
                });
            }
        });
    </script>

</div>

</body>
</html>