<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Main</title>
    <link rel="stylesheet" th:href="@{/css/headerStyle.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>

    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=351cf74523b79c29cc49c868a9f55b3b&autoload=false"></script>

    <style>
        /* ì§€ë„ ì˜ì—­ì„ í™•ì‹¤íˆ ë³´ì´ë„ë¡ ë†’ì´ë¥¼ 800pxë¡œ ì¡°ì • */
        #map {
            width: 100%;
            height: 600px;
            z-index: 1;
        }
    </style>
</head>
<body>
<!-- í—¤ë” ì˜ì—­: header.html ì˜ header fragment ì‚½ì… -->
<div class="header" th:replace="~{common/header :: header}"></div>

<div id="map">
</div>

<!-- í‘¸í„°ë„ fragment ë¼ë©´ ì´ë ‡ê²Œ -->
<div class="footer" th:replace="~{common/footer :: footer}"></div>
<script>
    // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸ (DOM ready ì „ì— ì„ ì–¸í•˜ì—¬ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ í•¨)
    var map;
    var positions = []; // JSONì—ì„œ ë¡œë“œí•œ ìœ„ì¹˜ ë°ì´í„° ì €ì¥ ë°°ì—´
    var markers = [];   // ì§€ë„ì— í‘œì‹œëœ ë§ˆì»¤ ê°ì²´ ì €ì¥ ë°°ì—´
    let foldFlag = false;
    let markerFlag = false;

    var iwContent = '<div style="padding:5px;">Hello World!</div>', // ì¸í¬ìœˆë„ìš°ì— í‘œì¶œë  ë‚´ìš©ìœ¼ë¡œ HTML ë¬¸ìì—´ì´ë‚˜ document elementê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤
        iwRemoveable = true; // removeable ì†ì„±ì„ ture ë¡œ ì„¤ì •í•˜ë©´ ì¸í¬ìœˆë„ìš°ë¥¼ ë‹«ì„ ìˆ˜ ìˆëŠ” xë²„íŠ¼ì´ í‘œì‹œë©ë‹ˆë‹¤

    // ì¸í¬ìœˆë„ìš°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var infowindow = new kakao.maps.InfoWindow({
        content : iwContent,
        removable : iwRemoveable
    });

    // ë§ˆì»¤ë¥¼ ì§€ë„ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
    function displayMarkers(data) {
        setMarkers(null);
        markers = [];
        positions = [];

        for (var i = 0; i < data.length; i++) {
            var latlng = new kakao.maps.LatLng(data[i].lat, data[i].lng);

            // positions ë°°ì—´ì— ì €ì¥ ì‹œì—ë„ ìƒˆ êµ¬ì¡° ë°˜ì˜
            positions.push({latlng: latlng, title: data[i].title});

            // ë§ˆì»¤ë¥¼ ìƒì„±í•˜ê³  ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤
            var marker = new kakao.maps.Marker({
                map: map,
                position: latlng,
                title: data[i].title
            });

            markers.push(marker);
        }
    }

    // ë§ˆì»¤ì˜ ê°€ì‹œì„±ì„ ì œì–´í•˜ëŠ” í•¨ìˆ˜
    function setMarkers(map) {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(map);
        }
    }

    // =========================================================================
    // â­ í•µì‹¬ ìˆ˜ì • ì‚¬í•­: DOMê³¼ API ë¡œë“œê°€ ì™„ë£Œëœ í›„ ì§€ë„ ì´ˆê¸°í™” ë° JSON ë¡œë“œ ì‹œì‘
    // =========================================================================
    function initMap() {
        // 1. ì§€ë„ ê°ì²´ ìƒì„± (ë³€ë™ ì—†ìŒ)
        var mapContainer = document.getElementById('map'),
            mapOption = {
                center: new kakao.maps.LatLng(37.473, 126.71), // ì´ˆê¸° ì¤‘ì‹¬ì„ ì¸ì²œ ê°œí•­ì¥ ê·¼ì²˜ë¡œ ì¡°ì •
                level: 8 // ì¸ì²œ~ì „êµ­ì„ ë³¼ ìˆ˜ ìˆë„ë¡ ë ˆë²¨ ì¡°ì •
            };
        map = new kakao.maps.Map(mapContainer, mapOption);

        // 2. ì™¸ë¶€ JSON íŒŒì¼ ë¡œë“œ (ê²½ë¡œ ì¬ìˆ˜ì •: /no_descr.json)
        $.getJSON('/json/no_descr.json', function (data) {
            displayMarkers(data);

            // ë°ì´í„°ê°€ ì¸ì²œ ì¤‘ì‹¬ìœ¼ë¡œ ì¹˜ìš°ì³ ìˆìœ¼ë¯€ë¡œ ì¤‘ì‹¬ ì¢Œí‘œë¥¼ ì¸ì²œ ì¤‘ì‹¬ìœ¼ë¡œ ë³€ê²½
            map.setCenter(new kakao.maps.LatLng(37.47, 126.71));
            map.relayout();

        }).fail(function (jqxhr, textStatus, error) {
            console.error("JSON íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:", textStatus, error);
        });
    }

    kakao.maps.event.addListener(marker, 'click', function() {
        // ë§ˆì»¤ ìœ„ì— ì¸í¬ìœˆë„ìš°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤
        infowindow.open(map, marker);
    });

    $(function () {
        // ê¸°ì¡´ autoload ë°©ì‹ì´ ë¬¸ì œë˜ì—ˆì„ ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë¯€ë¡œ, initMap() í˜¸ì¶œì„ load ì½œë°±ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        // í˜„ì¬ <head>ì— autoload=falseê°€ ì—†ìœ¼ë¯€ë¡œ kakao.maps.load(initMap)ì„ ì‚¬ìš©í•˜ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

        // ğŸš¨ ì„ì‹œ ì¡°ì¹˜: autoload=true ë°©ì‹ì´ë¯€ë¡œ, DOM readyì— initMap ì½”ë“œë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³µêµ¬í•©ë‹ˆë‹¤.
        // (ë§Œì•½ <head>ì— autoload=falseë¥¼ ì¶”ê°€í–ˆë‹¤ë©´ kakao.maps.load(initMap);ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤.)

        // ì§€ë„ë¥¼ ê·¸ë¦¬ëŠ” í•µì‹¬ ë¡œì§ì¸ initMap()ì„ DOMì´ ì¤€ë¹„ë˜ë©´ ë°”ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.
        kakao.maps.load(initMap);
    });
</script>
</body>
</html>
