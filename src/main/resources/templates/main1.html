<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:fragment="setContent(content)">
    <head>
        <meta charset="UTF-8">
        <title>Main</title>
        <link rel="stylesheet" th:href="@{/css/styles1.css}">

        <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
        <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
        <script type="text/javascript"
                src="//dapi.kakao.com/v2/maps/sdk.js?appkey=351cf74523b79c29cc49c868a9f55b3b&autoload=false&libraries=services"></script>

        <style>
            /* === 기본 폰트 및 배경 === */
            body, html {
                font-family: 'SUIT', 'Noto Sans KR', sans-serif;
                background-color: #F9F9F9; /* 매우 연한 회색 배경 */
            }

            /* * === ★★★ 1. 메인 레이아웃 (2단 레이아웃) ★★★ ===
             * 지도 컬럼과 사이드바 컬럼을 감싸는 Flex 컨테이너
            */
            .main-content-layout {
                display: flex;
                flex-wrap: wrap; /* (모바일 등에서 줄바꿈 대비) */
                max-width: 1680px; /* ★ (수정) 1600px -> 1680px로 전체 컨테이너 너비 확장 */
                margin: 20px auto 0 auto; /* 헤더와 간격, 중앙 정렬 */
                padding: 0 20px; /* 좌우 여백 */
                box-sizing: border-box;
            }

            /* === ★★★ 2. 지도 컬럼 (왼쪽) ★★★ === */
            .main-map-column {
                flex: 1; /* 남은 공간 모두 차지 */
                min-width: 980px; /* ★ (수정) 900px -> 980px (max-width와 비례하여 증가) */
            }

            /* === ★★★ 3. 사이드바 컬럼 (오른쪽) (수정됨) ★★★ === */
            .main-sidebar-column {
                flex: 0 0 320px; /* 320px 고정 너비 */
                margin-left: 24px;
                box-sizing: border-box;

                /* ★★★ (신규) 지도 높이(530px)에 맞추고, 스크롤 적용 ★★★ */
                height: 530px;
                overflow-y: auto;

                /* ★★★ (신규) 스크롤바 숨기기 (Firefox) ★★★ */
                scrollbar-width: none;
                /* ★★★ (신규) 스크롤바 숨기기 (IE, Edge legacy) ★★★ */
                -ms-overflow-style: none;
            }

            /* ★★★ (신규) 스크롤바 숨기기 (Chrome, Safari, Edge) ★★★ */
            .main-sidebar-column::-webkit-scrollbar {
                display: none;
            }


            /* === 헤더와 동일 폭의 지도 컨테이너 === */
            .map-container {
                width: 100%;
                margin: 0 auto;
                position: relative;
            }

            /* === 지도 크기 === */
            #map {
                width: 100%;
                height: 530px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
                z-index: 1;
                border-radius: 12px;
            }

            /* === 지도 오른쪽 툴바 (카카오 스타일) === */
            .map-toolbar {
                position: absolute;
                top: 20px;
                right: 20px;
                z-index: 3;
                background: #FFFFFF;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
                padding: 12px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .map-toolbar-title {
                font-weight: 600; /* Medium Bold */
                font-size: 15px;
                margin-bottom: 4px;
                text-align: center;
                color: #333;
            }

            .map-toolbar button {
                border: 1px solid #E0E0E0;
                border-radius: 6px;
                padding: 8px 12px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                background: #FFFFFF;
                color: #3C1E1E; /* 카카오 브라운 */
                white-space: nowrap;
                transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            }

            .map-toolbar button:hover {
                background: #FEE500; /* 카카오 옐로우 */
                border-color: #FEE500;
                color: #3C1E1E;
            }

            /* === 인포윈도우 카드 레이아웃 (카카오 스타일) === */
            .place-overlay {
                display: inline-block;
                font-family: 'SUIT', sans-serif;
                background: #FFFFFF;
                border-radius: 12px;
                border: 1px solid #E0E0E0;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                padding: 18px; /* 여백 증가 */
                max-width: 500px;
            }

            .place-overlay-inner {
                display: flex;
                align-items: flex-start;
                gap: 16px;
            }

            .po-text {
                flex: 1;
                font-size: 15px;
                line-height: 1.7;
            }

            .po-row {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin-bottom: 8px;
            }
            .po-row:last-child {
                margin-bottom: 0;
            }

            .po-label {
                display: inline-block;
                width: 45px;
                font-weight: 600;
                color: #111;
            }

            .po-value {
                margin-left: 8px;
                color: #555;
            }

            .po-right {
                width: 100px;
                text-align: center;
                flex-shrink: 0;
            }

            .po-right img {
                width: 80px;
                height: 80px;
                object-fit: cover;
                border: 1px solid #EEE;
                border-radius: 8px;
                display: block;
                margin: 0 auto 10px auto;
            }

            .po-image-placeholder {
                width: 80px;
                height: 80px;
                border: 1px dashed #CCC;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 13px;
                color: #777;
                margin: 0 auto 10px auto;
                box-sizing: border-box;
            }

            /* 카카오 버튼 스타일 */
            .po-btn {
                display: inline-block;
                font-size: 13px;
                font-weight: 600;
                padding: 7px 14px;
                border: none;
                border-radius: 6px;
                background: #FEE500; /* 카카오 옐로우 */
                color: #3C1E1E; /* 카카오 브라운 */
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

            .po-btn:hover {
                background: #F8D900; /* 살짝 어두운 옐로우 */
            }

            .weather-emoji {
                font-size: 18px;
                margin-left: 4px;
                vertical-align: middle;
            }

            /* * === ★★★ 4. TOP 3 리스트 영역 (사이드바에 맞게 수정) ★★★
            */
            .top-rated-container {
                width: 100%; /* 사이드바 컬럼 100% */
                margin: 0 0 24px 0; /* 위/중앙 정렬 -> 바닥 여백만 */
                font-family: 'SUIT', sans-serif;
            }

            .top-rated-title {
                font-size: 20px;
                font-weight: 700;
                margin-bottom: 16px;
                color: #191919;
            }

            .top-rated-list {
                display: flex;
                flex-direction: column; /* 세로로 쌓기 */
                gap: 16px; /* 카드 사이 간격 */
            }

            /* ★ 리스트 아이템 (가로형으로 변경) - CSS Grid 사용 */
            .top-rated-item {
                display: grid;
                grid-template-columns: 80px 1fr; /* 80px 이미지 | 나머지 텍스트 */
                grid-template-rows: auto auto; /* 텍스트 2줄 */
                gap: 0 12px; /* 텍스트와 이미지 사이 간격 */

                width: 100%;
                min-width: 0;
                max-width: 100%;

                background: #FFFFFF;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                padding: 10px; /* 내부 여백 */
                cursor: pointer;
                transition: transform 0.2s ease, box-shadow 0.2s ease;
                overflow: hidden;
                box-sizing: border-box;
            }

            .top-rated-item:hover {
                transform: translateY(-3px);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            }

            /* ★ 리스트 이미지 (Grid 1열 1~3행 차지) */
            .top-rated-img,
            .top-rated-img-placeholder {
                grid-column: 1 / 2;
                grid-row: 1 / 3;
                width: 80px;
                height: 80px;
                object-fit: cover;
                margin-bottom: 0;
                border: none;
                border-radius: 8px; /* 이미지 모서리 둥글게 */
            }

            .top-rated-img-placeholder {
                border: 1px dashed #CCC;
                background-color: #FAFAFA;
            }

            /* ★ 리스트 텍스트 (Grid 2열 1행) */
            .top-rated-name {
                grid-column: 2 / 3;
                grid-row: 1 / 2;
                font-size: 15px;
                font-weight: 600;
                color: #333;
                margin: 0;
                padding: 0;
                align-self: end; /* 셀의 아래쪽에 붙이기 */
            }

            /* ★ 리스트 텍스트 (Grid 2열 2행) */
            .top-rated-score {
                grid-column: 2 / 3;
                grid-row: 2 / 3;
                font-size: 13px;
                color: #555;
                margin: 0;
                padding: 0;
                align-self: start; /* 셀의 위쪽에 붙이기 */
            }

        </style>
    </head>
    <body>

    <div class="header">
        <th:block th:replace="~{common/header :: header}"/>
    </div>


    <div class="main-content-layout">

        <div class="main-map-column">
            <div class="map-container">
                <div id="map"></div>

                <div class="map-toolbar">
                    <div class="map-toolbar-title">주변 장소</div>
                    <button type="button" onclick="searchPoiCategory('FD6')">식당</button>
                    <button type="button" onclick="searchPoiCategory('CE7')">카페</button>
                    <button type="button" onclick="searchPoiCategory('AD5')">숙소</button>
                    <button type="button" onclick="clearPoiMarkers()">마커 지우기</button>
                </div>
            </div>
        </div>

        <div class="main-sidebar-column">

            <div class="top-rated-container">
                <div class="top-rated-title">평점 TOP 3 관광지</div>
                <div id="top-rated-list" class="top-rated-list">
                </div>
            </div>

            <div class="top-rated-container">
                <div class="top-rated-title">즐겨찾기 TOP 3 관광지</div>
                <div id="top-favorite-list" class="top-rated-list">
                </div>
            </div>

        </div>

    </div>

    <script>
        // ==========================================================
        // ★★★ JavaScript는 수정할 필요가 없습니다. ★★★
        // (기존 코드와 동일)
        // ==========================================================

        var map;
        var markers = []; // 기존 관광지 마커들
        var placesService; // Kakao Places 서비스 객체
        var poiMarkers = []; // 식당/카페/숙소 등 Kakao POI 마커들

        window.selectedPlaceDetail = null;   // /api/v1/places/{id} 결과
        window.selectedMarker = null;        // 클릭된 관광지 마커
        window.selectedInfowindow = null;    // 관광지용 infowindow

        // ===== 팝업 내용 템플릿 (관광지용) =====
        function buildInfoContent(place) {

            // 평균 평점 & 리뷰 수 계산
            let avgText = '-';
            let reviewCount = place.reviewCount || place.rateCount || 0;

            if (place.avgRate !== undefined && place.avgRate !== null && place.avgRate > 0) {
                avgText = place.avgRate.toFixed(1);          // 예: 4.3
            } else if (place.rate !== undefined && place.rate !== null) {
                // 백엔드가 아직 avgRate 안 주는 경우를 대비한 fallback
                avgText = place.rate.toFixed ? place.rate.toFixed(1) : place.rate;
            }

            let ratingDisplay = avgText;
            if (reviewCount > 0) {
                ratingDisplay += ` (${reviewCount}개)`;
            }

            const imagePart = place.imageUrl
                ? `<img src="${place.imageUrl}" alt="이미지">`
                : `<div class="po-image-placeholder">이미지</div>`;
            const detailUrl = `/places/${place.no}`;

            // 날씨 아이콘 (있을 때만 표시)
            const weatherPart = place.weatherEmoji
                ? `<span class="weather-emoji" title="${place.weatherText || ' '}">
           ${place.weatherEmoji}
       </span>`
                : '';

            return `
        <div class="place-overlay">
          <div class="place-overlay-inner">
            <div class="po-text">
              <div class="po-row">
                <span class="po-label">이름</span>
                <span class="po-value">
                  ${place.title || ''}${weatherPart}
                </span>
              </div>
              <div class="po-row">
                <span class="po-label">주소</span>
                <span class="po-value">${place.address || ''}</span>
              </div>
              <div class="po-row">
                <span class="po-label">평점</span>
                <span class="po-value">${ratingDisplay}</span>
              </div>
            </div>
            <div class="po-right">
              ${imagePart}
              <button type="button" class="po-btn"
                      onclick="location.href='${detailUrl}'">바로가기</button>
            </div>
          </div>
        </div>`;
        }

        // ===== 거리용 인포윈도우 내용 =====
        function buildPoiContent(place) {
            const roadAddr = place.road_address_name || '';
            const addr = place.address_name || '';
            const phone = place.phone || '-';

            return `
        <div class="place-overlay">
          <div class="place-overlay-inner">
            <div class="po-text">
              <div class="po-row"><span class="po-label">이름</span><span class="po-value">${place.place_name}</span></div>
              <div class="po-row"><span class="po-label">전화</span><span class="po-value">${phone}</span></div>
              <div class="po-row">
                <span class="po-label">링크</span>
                <span class="po-value">
                  <a href="${place.place_url}" target="_blank" style="color:blue; text-decoration:underline;">카카오맵에서 보기</a>
                </span>
              </div>
            </div>
          </div>
        </div>`;
        }

        // ===== 상세정보 로딩 (관광지용) =====
        function loadPlaceDetail(placeId, marker, infowindow) {
            fetch(`/api/v1/places/${placeId}`)
                .then(response => response.json())
                .then(result => {
                    if (result.status !== 200 || !result.data) {
                        alert('관광지 정보를 불러오지 못했습니다.');
                        return;
                    }

                    const place = result.data;

                    // lat/lng 없으면 마커에서 보정
                    if (!place.lat || !place.lng) {
                        const pos = marker.getPosition();
                        place.lat = pos.getLat();
                        place.lng = pos.getLng();
                    }

                    // 2) 평균 평점 조회 (/api/v1/reviews/rating/{placeId})
                    return fetch(`/api/v1/reviews/rating/${placeId}`)
                        .then(res => res.json())
                        .then(rateResult => {
                            // rateResult가 ResponseDto({status, message, data})})라고 가정
                            let avg = null;

                            if (rateResult && typeof rateResult === 'object') {
                                // ResponseDto 형태일 때
                                if ('data' in rateResult && rateResult.data != null) {
                                    avg = rateResult.data;
                                }
                            } else if (typeof rateResult === 'number') {
                                // 혹시 그냥 숫자만 내려줄 때
                                avg = rateResult;
                            }

                            if (avg != null && !isNaN(avg)) {
                                place.avgRate = avg;
                            }

                            return place;   // 다음 then으로 넘겨줌
                        })
                        .catch(err => {
                            console.error('평점 조회 실패:', err);
                            return place;
                        });
                })
                .then(place => {
                    if (!place) return;

                    window.selectedPlaceDetail = place;

                    const content = buildInfoContent(place);
                    infowindow.setContent(content);
                    infowindow.open(map, marker);
                })
                .catch(err => {
                    console.error('Error loading place detail from main:', err);
                    alert('관광지 정보를 불러오는 중 오류가 발생했습니다.');
                });
        }

        // ===== 관광지 마커 표시 =====
        function displayMarkers(data, infowindow) {
            for (var i = 0; i < data.length; i++) {
                var latlng = new kakao.maps.LatLng(data[i].lat, data[i].lng);
                var placeId = data[i].no;

                var marker = new kakao.maps.Marker({
                    map: map,
                    position: latlng,
                    title: data[i].title
                });

                (function (marker, placeId) {
                    kakao.maps.event.addListener(marker, 'click', function () {
                        map.setCenter(marker.getPosition());      // 정확하게 중심 이동
                        map.setLevel(3, {animate: true});         // 확대 유지

                        // 현재 선택된 마커/인포윈도우 기억
                        window.selectedMarker = marker;
                        window.selectedInfowindow = infowindow;

                        loadPlaceDetail(placeId, marker, infowindow);
                    });
                })(marker, placeId);


                markers.push(marker);
            }
        }

        // ===== Kakao POI 마커 지우기 =====
        function clearPoiMarkers() {
            for (var i = 0; i < poiMarkers.length; i++) {
                poiMarkers[i].setMap(null);
            }
            poiMarkers = [];
        }

        // ===== Kakao POI 검색 (식당/카페/숙소) =====
        function searchPoiCategory(categoryCode) {
            if (!placesService || !map) return;

            clearPoiMarkers(); // 기존 POI 마커 삭제

            var center = map.getCenter();  // 현재 지도 중심 좌표
            var callback = function (data, status) {
                if (status === kakao.maps.services.Status.OK && data.length > 0) {
                    for (var i = 0; i < data.length; i++) {
                        (function (place) {
                            var position = new kakao.maps.LatLng(place.y, place.x);
                            var marker = new kakao.maps.Marker({
                                map: map,
                                position: position,
                                title: place.place_name
                            });

                            kakao.maps.event.addListener(marker, 'click', function () {
                                var content = buildPoiContent(place);
                                poiInfowindow.setContent(content);
                                poiInfowindow.open(map, marker);
                            });

                            poiMarkers.push(marker);
                        })(data[i]);
                    }
                } else {
                    alert('해당 장소의 주변에 해당 카테고리의 장소가 없습니다.');
                }
            };

            placesService.categorySearch(categoryCode, callback, {
                location: center,
                radius: 500
            });
        }

        function showWeather() {
            // 1) 관광지가 선택되지 않은 경우
            if (!window.selectedPlaceDetail) {
                alert('먼저 지도의 관광지 마커를 클릭해서 상세정보를 띄워 주세요.');
                return;
            }

            var place = window.selectedPlaceDetail;
            if (!place.lat || !place.lng) {
                alert('선택된 관광지의 좌표를 알 수 없습니다.');
                return;
            }

            // 2) 백엔드 날씨 API 호출 (lat/lng을 넘김)
            $.ajax({
                url: '/api/v1/weather',
                method: 'GET',
                data: {
                    lat: place.lat,
                    lng: place.lng
                },
                dataType: 'json'
            }).done(function (res) {
                if (res.status !== 200 || !res.data) {
                    alert('날씨 정보를 불러오지 못했습니다.');
                    return;
                }

                var weather = res.data;

                // 3) 기존 place에 날씨 정보 덧입혀서 다시 인포윈도우 내용 생성
                var placeWithWeather = Object.assign({}, place, {
                    weatherEmoji: weather.emoji,
                    weatherText: weather.korean
                });

                var content = buildInfoContent(placeWithWeather);

                if (window.selectedInfowindow && window.selectedMarker) {
                    window.selectedInfowindow.setContent(content);
                    window.selectedInfowindow.open(map, window.selectedMarker);
                }
            }).fail(function (xhr, status, error) {
                console.error('날씨 조회 실패:', status, error);
                alert('날씨 정보를 불러오는 중 오류가 발생했습니다.');
            });
        }

        // ===== 지도 초기화 =====
        function initMap() {
            var mapContainer = document.getElementById('map'),
                mapOption = {
                    center: new kakao.maps.LatLng(36.55, 127.83), // 속리산 중심
                    level: 12
                };
            map = new kakao.maps.Map(mapContainer, mapOption);

            // 관광지용 인포윈도우
            var infowindow = new kakao.maps.InfoWindow({
                removable: true
            });

            // Kakao POI용 인포윈도우
            window.poiInfowindow = new kakao.maps.InfoWindow({
                removable: true
            });

            placesService = new kakao.maps.services.Places();

            // 기존 관광지 JSON 로딩
            $.getJSON('/json/no_descr.json', function (data) {
                displayMarkers(data, infowindow);
                map.relayout();
            }).fail(function (jqxhr, textStatus, error) {
                console.error("JSON 파일 로드 실패:", textStatus, error);
            });
        }

        // ===== 평점 TOP 3 리스트 로딩 =====
        function loadTopRatedPlaces() {
            $.ajax({
                url: '/api/v1/main/rating',
                method: 'GET',
                dataType: 'json'
            }).done(function (res) {
                var $list = $('#top-rated-list');
                $list.empty();

                // 응답이 ResponseDto 형태라고 가정: { status, message, data }
                var list = res.data || res;   // 혹시 그냥 배열로 줄 때도 대비

                if (!Array.isArray(list) || list.length === 0) {
                    $list.append('<span>등록된 리뷰가 없습니다.</span>');
                    return;
                }

                // API가 더 많은 데이터를 반환하더라도 0, 1, 2 (총 3개)만 잘라서 사용
                list.slice(0, 3).forEach(function (item) {
                    var imgHtml;
                    var imageUrl = item.imgUrl; // 예: "2d7396cb...png"

                    // imgUrl이 존재하고, http로 시작하지 않는 내부 파일인 경우
                    if (imageUrl && !imageUrl.startsWith('http')) {
                        // 리뷰 상세 페이지와 동일하게 /multiimgs/ 경로를 붙여줍니다.
                        imageUrl = '/multiimgs/' + imageUrl;
                    }

                    if (imageUrl) {
                        imgHtml = '<img class="top-rated-img" src="' + imageUrl + '" alt="이미지">';
                    } else {
                        imgHtml = '<div class="top-rated-img-placeholder">이미지 없음</div>';
                    }

                    var avg = (item.avgRate != null) ? item.avgRate.toFixed(1) : '-';

                    var html =
                        '<div class="top-rated-item" onclick="moveToPlaceDetail(' + item.placeNo + ')">' +
                        imgHtml +
                        '<div class="top-rated-name" title="' + (item.placeTitle || '') + '">' +
                        (item.placeTitle || '') +
                        '</div>' +
                        '<div class="top-rated-score"> ' + avg + '/5.0 (' + item.rateCount + ')</div>' +
                        '</div>';

                    $list.append(html);
                });
            }).fail(function (xhr, status, error) {
                console.error('TOP 3 로딩 실패:', status, error);
            });
        }

        // ===== 즐겨찾기 TOP 3 리스트 로딩 =====
        function loadTopFavoritePlaces() {
            $.ajax({
                url: '/api/v1/main/favorites',
                method: 'GET',
                dataType: 'json'
            }).done(function (res) {
                var $list = $('#top-favorite-list');
                $list.empty();

                var list = res.data || res;  // ResponseDto.data 또는 그냥 배열

                if (!Array.isArray(list) || list.length === 0) {
                    $list.append('<span>즐겨찾기한 장소가 없습니다.</span>');
                    return;
                }

                // API가 더 많은 데이터를 반환하더라도 0, 1, 2 (총 3개)만 잘라서 사용
                list.slice(0, 3).forEach(function (item) {
                    var imgHtml;

                    // 즐겨찾기는 이미 http://... URL이므로 수정 필요 없음
                    if (item.imgUrl) {
                        imgHtml = '<img class="top-rated-img" src="' + item.imgUrl + '" alt="이미지">';
                    } else {
                        imgHtml = '<div class="top-rated-img-placeholder">이미지 없음</div>';
                    }

                    var html =
                        '<div class="top-rated-item" onclick="moveToPlaceDetail(' + item.placeNo + ')">' +
                        imgHtml +
                        '<div class="top-rated-name" title="' + (item.placeTitle || '') + '">' +
                        (item.placeTitle || '') +
                        '</div>' +
                        '<div class="top-rated-score"> ' + item.favoriteCount + '회</div>' +
                        '</div>';

                    $list.append(html);
                });
            }).fail(function (xhr, status, error) {
                console.error('즐겨찾기 TOP 3 로딩 실패:', status, error);
            });
        }

        // ===== 리스트 클릭 시 장소 상세 페이지로 이동 =====
        function moveToPlaceDetail(placeNo) {
            if (!placeNo) return;
            window.location.href = '/places/' + placeNo;
        }

        $(function () {
            kakao.maps.load(initMap);
            loadTopRatedPlaces();
            loadTopFavoritePlaces();
        });
    </script>
    </body>
</th:block>
</html>