<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ìƒí’ˆ ìƒì„¸</title>
    <link rel="stylesheet" th:href="@{/css/styles1.css}">
    <style>
        /* âœ… ì „ì²´ ë ˆì´ì•„ì›ƒ */
        body {
            font-family: "Noto Sans KR", sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 24px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        h2 {
            margin-bottom: 12px;
            color: #1976d2;
        }

        img {
            border-radius: 8px;
            margin-bottom: 16px;
            display: block;
        }

        /* âœ… íƒ­ ë²„íŠ¼ */
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .tab-buttons button {
            padding: 10px 18px;
            border: none;
            background: #f1f1f1;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .tab-buttons button.active {
            background: #1976d2;
            color: #fff;
        }

        .tab-content {
            display: none;
            padding: 16px;
            border-radius: 8px;
            background: #fafafa;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {opacity: 0;}
            to {opacity: 1;}
        }

        #details {
            width: 100%;
            height: 350px;
            border-radius: 8px;
            overflow: hidden;
        }

        /* âœ… ë§í¬ */
        a.home-link {
            display: inline-block;
            margin-top: 24px;
            text-decoration: none;
            color: #1976d2;
            font-weight: 600;
        }

        a.home-link:hover {
            text-decoration: underline;
        }

        /* âœ… ë‚ ì”¨ ì •ë³´ */
        .weather-info {
            line-height: 1.6;
            font-size: 1.05rem;
        }

        .weather-icon {
            font-size: 2rem;
            margin-right: 8px;
            vertical-align: middle;
        }

        #reviewList {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: fixed; /* ê³ ì • ë ˆì´ì•„ì›ƒ */
        }

        #reviewList th, #reviewList td {
            text-align: center;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            word-wrap: break-word; /* ê¸´ ê¸€ ìë™ ì¤„ë°”ê¿ˆ */
        }

        #reviewList th {
            background-color: #f7f7f7;
            font-weight: 600;
        }

        #reviewList tr:hover {
            background-color: #f9f9f9;
        }

        .review-rate {
            color: #FFD700;
        }

        /* âœ… ê° ì—´ ë„ˆë¹„ ì§€ì • (ë¹„ìœ¨ ì¡°ì • ê°€ëŠ¥) */
        #reviewList th:nth-child(1),
        #reviewList td:nth-child(1) {
            width: 18%; /* íƒ€ì´í‹€ */
        }

        #reviewList th:nth-child(2),
        #reviewList td:nth-child(2) {
            width: 52%; /* ë‚´ìš© - ê°€ì¥ ë„“ê²Œ */
            text-align: left;
            padding-left: 15px;
        }

        #reviewList th:nth-child(3),
        #reviewList td:nth-child(3) {
            width: 18%; /* ì‘ì„±ì */
        }

        #reviewList th:nth-child(4),
        #reviewList td:nth-child(4) {
            width: 12%; /* í‰ì  */
        }

    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="header">
    <th:block th:replace="~{common/header :: header}"/>
</div>

<div class="container">
    <h2 id="placeTitle"></h2>
    <img id="placeImage" alt="ê´€ê´‘ì§€ ì´ë¯¸ì§€" style="width: 300px; height: auto;">
    <p id="placeDescription"></p>
    <p id="placeAddress"></p>

    <div class="tab-buttons">
        <button class="tab-btn active" data-target="review">ê´€ë ¨ ë¦¬ë·°</button>
        <button class="tab-btn" data-target="details">ì£¼ë³€ ì§€ë„</button>
        <button class="tab-btn" data-target="links">ë‚ ì”¨ ì •ë³´</button>
    </div>

    <!-- âœ… ë¦¬ë·° íƒ­ -->
    <div id="review" class="tab-content active">
        <h3>ê´€ê´‘ì§€ ë¦¬ë·°</h3>
        <ul id="reviewList"></ul>
        <div id="pagination"></div>
    </div>

    <!-- âœ… ì§€ë„ íƒ­ -->
    <div id="details" class="tab-content"></div>

    <!-- âœ… ë‚ ì”¨ íƒ­ -->
    <div id="links" class="tab-content">
        <h3>ë‚ ì”¨ ì •ë³´</h3>
        <div class="weather-info" id="weatherInfo"></div>
    </div>

    <a href="/main" class="home-link">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
</div>



<!-- âœ… Kakao Map -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=db0e01b397787c97dae0c9b59e1cca31"></script>

<script>
    const placeNo = [[${placeNo}]];
    let map, marker;

    async function loadPlaceDetail() {
        try {
            const response = await fetch(`http://localhost:8090/api/v1/places/${placeNo}`);
            const result = await response.json();

            if (result.status === 200 && result.data) {
                const place = result.data;
                $('#placeTitle').text(place.title);
                $('#placeImage').attr('src', place.imageUrl || '/path/to/default-image.jpg');
                $('#placeDescription').text(place.description);
                $('#placeAddress').text(place.address);

                initReview(1);
                initMap(place.lat, place.lng);
                initWeather(place.lat, place.lng);
            } else {
                alert('ê´€ê´‘ì§€ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('Error loading place detail:', error);
            alert('ê´€ê´‘ì§€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    function initMap(lat, lng) {
        const mapContainer = document.getElementById('details');
        const mapOption = { center: new kakao.maps.LatLng(lat, lng), level: 3 };
        map = new kakao.maps.Map(mapContainer, mapOption);
        marker = new kakao.maps.Marker({ position: mapOption.center });
        marker.setMap(map);
    }

    function getWeatherIcon(main) {
        const iconMap = {
            Clear: "â˜€ï¸",
            Clouds: "â˜ï¸",
            Rain: "ğŸŒ§ï¸",
            Drizzle: "ğŸŒ¦ï¸",
            Thunderstorm: "â›ˆï¸",
            Snow: "â„ï¸",
            Mist: "ğŸŒ«ï¸"
        };
        return iconMap[main] || "ğŸŒ¤ï¸";
    }

    function initWeather(lat, lng) {
        const info = $('#weatherInfo');
        info.html("<p>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>");

        $.ajax({
            url: `http://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&lang=kr&appid=a1960ea44c537a51418257f763c42f66`,
            dataType: 'json',
            success: function (data) {
                const icon = getWeatherIcon(data.weather[0].main);
                info.html(`
                    <span class="weather-icon">${icon}</span><strong>${data.name}</strong> í˜„ì¬ ë‚ ì”¨<br>
                    ${data.weather[0].description}<br>
                    ğŸŒ¡ ìµœê³ : ${data.main.temp_max}Â°C / ìµœì €: ${data.main.temp_min}Â°C<br>
                    ğŸ’¨ í’ì†: ${data.wind.speed} m/s<br>
                    ì²´ê°ì˜¨ë„: ${data.main.feels_like}Â°C<br>
                    êµ¬ë¦„: ${data.clouds.all}%
                `);
            },
            error: function () {
                info.html("ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    async function initReview(offset) {
        try {
            const response = await fetch(`http://localhost:8090/api/v1/reviews/${placeNo}?offset=${offset}`);
            const result = await response.json();

            if (result.status === 200 && result.data?.data) {
                const reviews = result.data.data;
                const pageInfo = result.data.pageInfo;
                const reviewList = $('#reviewList').empty();

                if (reviews.length === 0) {
                  //  reviewList.html('<li>ê´€ë ¨ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>');
                    reviewList.html('<tr><td colspan="4">ê´€ë ¨ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
                    return;
                }
                reviewList.append(`
                <tr>
                    <th>íƒ€ì´í‹€</th>
                    <th>ë‚´ìš©</th>
                    <th>ì‘ì„±ì</th>
                    <th>í‰ì </th>
                </tr>
               `);

                reviews.forEach(r => {
                    const stars = 'â­'.repeat(r.rate);
                    reviewList.append(`
                     <tr>
                        <td>${r.title}</td>
                        <td>${r.content}</td>
                        <td>${r.email}</td>
                        <td class="review-rate">${stars}</td>
                    </tr>
                    `);
                });

                renderPagination(pageInfo);
            } else {
               $('#reviewList').html('<tr><td colspan="4">ë¦¬ë·° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>');
            }
        } catch (error) {
            console.error('Failed to load reviews:', error);
            $('#reviewList').html('<tr><td colspan="4">ë¦¬ë·° ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>');
        }
    }

    function renderPagination(pageInfo) {
        if (!pageInfo) return;
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        if (pageInfo.pageNo > 1) {
            const prev = document.createElement('button');
            prev.textContent = 'ì´ì „';
            prev.onclick = () => initReview(pageInfo.pageNo - 1);
            pagination.appendChild(prev);
        }

        for (let i = pageInfo.startPage; i <= pageInfo.endPage; i++) {
            const button = document.createElement('button');
            button.textContent = i;
            button.classList.toggle('active', i === pageInfo.pageNo);
            button.onclick = () => initReview(i);
            pagination.appendChild(button);
        }

        if (pageInfo.pageNo < pageInfo.maxPage) {
            const next = document.createElement('button');
            next.textContent = 'ë‹¤ìŒ';
            next.onclick = () => initReview(pageInfo.pageNo + 1);
            pagination.appendChild(next);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadPlaceDetail();

        const buttons = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');

        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                buttons.forEach(b => b.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(btn.dataset.target).classList.add('active');

                if (btn.dataset.target === 'details' && map) {
                    setTimeout(() => {
                        map.relayout();
                        map.setCenter(marker.getPosition());
                    }, 200);
                }
            });
        });
    });
</script>
</body>
</html>
