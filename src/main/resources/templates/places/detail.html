<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê´€ê´‘ì§€ ìƒì„¸</title>
    <link rel="stylesheet" th:href="@{/css/styles1.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: "Noto Sans KR", sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 24px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        h2 {
            margin-bottom: 12px;
            color: #1976d2;
        }

        .place-detail {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }

        .place-detail img {
            width: 380px;
            height: auto;
            border-radius: 12px;
            object-fit: cover;
        }

        .place-info {
            flex: 1;
        }

        .place-info p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .favorite-btn {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            color: white;
            border: none;
            border-radius: 20px;
            width: 120px;
            height: 48px;
            font-size: 18px;
            font-weight: 600;
            gap: 8px;
            cursor: pointer;
            transition: all 0.25s ease-in-out;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.25);
        }

        .favorite-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #ff4d4d, #ff6b6b);
            box-shadow: 0 6px 14px rgba(255, 107, 107, 0.35);
        }

        .favorite-btn:active {
            transform: scale(0.95);
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin: 30px 0 10px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .tab-buttons button {
            padding: 10px 18px;
            border: none;
            background: #f1f1f1;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .tab-buttons button.active {
            background: #1976d2;
            color: #fff;
        }

        .tab-content {
            display: none;
            padding: 30px;
            border-radius: 8px;
            background: #fafafa;
            min-height: 350px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        #details {
            width: 100%;
            height: 350px;
            border-radius: 8px;
            overflow: hidden;
        }

        #reviewList {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: fixed;
        }

        #reviewList th, #reviewList td {
            text-align: center;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            word-wrap: break-word;
        }

        #reviewList th {
            background-color: #f7f7f7;
            font-weight: 600;
        }

        a.home-link {
            display: inline-block;
            margin-top: 24px;
            text-decoration: none;
            color: #1976d2;
            font-weight: 600;
        }

        a.home-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
<div class="header">
    <th:block th:replace="~{common/header :: header}"/>
</div>

<div class="container">
    <h2 id="placeTitle"></h2>

    <div class="place-detail">
        <img id="placeImage" alt="ê´€ê´‘ì§€ ì´ë¯¸ì§€">
        <div class="place-info">
            <p id="placeDescription"></p>
            <br>
            <p><strong>ì£¼ì†Œ:</strong> <span id="placeAddress"></span></p>
        </div>
    </div>

    <div id="placeFavorite" style="margin-top: 10px; text-align: left;"></div>

    <div class="tab-buttons">
        <button class="tab-btn active" data-target="review">ê´€ë ¨ ë¦¬ë·°</button>
        <button class="tab-btn" data-target="details">ì£¼ë³€ ì§€ë„</button>
        <button class="tab-btn" data-target="links">ë‚ ì”¨ ì •ë³´</button>
    </div>

    <div id="review" class="tab-content active">
        <table id="reviewList"></table>
        <div id="pagination"></div>
    </div>

    <div id="details" class="tab-content"></div>

    <div id="links" class="tab-content">
        <div class="weather-info" id="weatherInfo"></div>
    </div>

    <a href="/main" class="home-link">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=db0e01b397787c97dae0c9b59e1cca31"></script>

<script>
    const placeNo = [[${placeNo}]];
    let map, marker;

    async function loadPlaceDetail() {
        try {
            const response = await fetch(`http://localhost:8090/api/v1/places/${placeNo}`);
            const result = await response.json();

            if (result.status === 200 && result.data) {
                const place = result.data;
                $('#placeTitle').text(place.title);
                $('#placeImage').attr('src', place.imageUrl || '/path/to/default-image.jpg');
                $('#placeDescription').text(place.description);
                $('#placeAddress').text(place.address);

                const buttonTag = `
                    <button id="favoriteBtn" class="favorite-btn" data-id="${placeNo}" title="ì¦ê²¨ì°¾ê¸°">
                        <i class="fa-solid fa-heart"></i> ì¶”ê°€í•˜ê¸°
                    </button>`;
                $('#placeFavorite').html(buttonTag);

                initReview(1);
                initMap(place.lat, place.lng);
                initWeather(place.lat, place.lng);
            }
        } catch (error) {
            console.error('Error loading place detail:', error);
        }
    }

    function initMap(lat, lng) {
        const mapContainer = document.getElementById('details');
        const mapOption = { center: new kakao.maps.LatLng(lat, lng), level: 3 };
        map = new kakao.maps.Map(mapContainer, mapOption);
        marker = new kakao.maps.Marker({ position: mapOption.center });
        marker.setMap(map);
    }

    function initWeather(lat, lng) {
        const info = $('#weatherInfo');
        info.html("<p>ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>");

        $.ajax({
            url: `http://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&lang=kr&appid=a1960ea44c537a51418257f763c42f66`,
            dataType: 'json',
            success: function (data) {
                const icon = getWeatherIcon(data.weather[0].main);
                info.html(`
                    <span class="weather-icon">${icon}</span> í˜„ì¬ ë‚ ì”¨<br>
                    ${data.weather[0].description}<br>
                    ğŸŒ¡ ìµœê³ : ${data.main.temp_max}Â°C / ìµœì €: ${data.main.temp_min}Â°C<br>
                    ğŸ’¨ í’ì†: ${data.wind.speed} m/s<br>
                    ì²´ê°ì˜¨ë„: ${data.main.feels_like}Â°C<br>
                    êµ¬ë¦„: ${data.clouds.all}%
                `);
            },
            error: function () {
                info.html("ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    }

    async function initReview(offset) {
        try {
            const response = await fetch(`http://localhost:8090/api/v1/reviews/place-detail/${placeNo}?offset=${offset}`);
            const result = await response.json();

            const reviewList = $('#reviewList').empty();

            if (result.status === 200 && result.data?.data?.length) {
                const reviews = result.data.data;
                const pageInfo = result.data.pageInfo;

                reviewList.append(`
                    <tr><th>íƒ€ì´í‹€</th><th>ë‚´ìš©</th><th>ì‘ì„±ì</th><th>í‰ì </th></tr>
                `);

                reviews.forEach(r => {
                    const stars = 'â­'.repeat(r.rate);
                    reviewList.append(`
                        <tr>
                            <td>${r.title}</td>
                            <td>${r.content}</td>
                            <td>${r.writerEmail}</td>
                            <td class="review-rate">${stars}</td>
                        </tr>
                    `);
                });

                renderPagination(pageInfo);
            } else {
                reviewList.html('<tr><td colspan="4">ê´€ë ¨ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
            }
        } catch (error) {
            console.error('Failed to load reviews:', error);
        }
    }

    function renderPagination(pageInfo) {
        if (!pageInfo) return;
        const pagination = $('#pagination').empty();

        if (pageInfo.pageNo > 1)
            pagination.append(`<button onclick="initReview(${pageInfo.pageNo - 1})">ì´ì „</button>`);

        for (let i = pageInfo.startPage; i <= pageInfo.endPage; i++) {
            pagination.append(`<button class="${i === pageInfo.pageNo ? 'active' : ''}" onclick="initReview(${i})">${i}</button>`);
        }

        if (pageInfo.pageNo < pageInfo.maxPage)
            pagination.append(`<button onclick="initReview(${pageInfo.pageNo + 1})">ë‹¤ìŒ</button>`);
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadPlaceDetail();

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(btn.dataset.target).classList.add('active');

                if (btn.dataset.target === 'details' && map) {
                    setTimeout(() => {
                        map.relayout();
                        map.setCenter(marker.getPosition());
                    }, 200);
                }
            });
        });

        /* â­â­â­ ì¦ê²¨ì°¾ê¸° ë“±ë¡ ì´ë²¤íŠ¸ (ì¤‘ë³µ ì²´í¬ í¬í•¨) */
        document.getElementById('placeFavorite').addEventListener('click', async (event) => {
            const btn = event.target.closest('.favorite-btn');
            if (!btn) return;

            const placeNo = btn.getAttribute('data-id');
            if (!placeNo) return;

            const formData = new FormData();
            formData.append('placeNo', placeNo);

            if (confirm('ì¦ê²¨ì°¾ê¸°ë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    const response = await fetch(`/api/v1/favorites/favorite`, {
                        method: 'POST',
                        body: formData
                    });

                    let result = null;
                    try {
                        result = await response.json();
                    } catch (e) {}

                    if (response.status === 200 || response.status === 201) {
                        alert('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                    else if (response.status === 409) {
                        alert("ì´ë¯¸ ì¦ê²¨ì°¾ê¸°ë¥¼ ë“±ë¡í•˜ì…¨ìŠµë‹ˆë‹¤.");
                    }
                    else if (response.status === 500) {
                        if (result && result.message && result.message.includes("ì´ë¯¸ ì¦ê²¨ì°¾ê¸°ë¥¼")) {
                            alert("ì´ë¯¸ ì¦ê²¨ì°¾ê¸°ë¥¼ ë“±ë¡í•˜ì…¨ìŠµë‹ˆë‹¤.");
                        } else {
                            alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        }
                    }
                    else {
                        alert('ë“±ë¡ ì‹¤íŒ¨: ' + response.status);
                    }

                } catch (error) {
                    alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });
    });
</script>
</body>
</html>
