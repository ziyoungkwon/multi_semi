<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.multi.multi_semi.review.dao.ReviewMapper">

    <select id="findReviewList" resultType="ReviewResDTO">
        select
            r.no as no,
            p.title as placeTitle,
            m.id as writer,
            m.email as writerEmail,
            r.title as title,
            r.content as content,
            r.img_url as imgUrl,
            r.rate as rate,
            r.created_at as createdAt,
            r.modified_at as updatedAt
        from rev r
                 join place p on r.place_no = p.no
                 join mem m on r.writer_email = m.email
        order by r.no
    </select>

    <select id="findReviewByNo" resultType = "ReviewResDTO">
        select
            r.no as no,
            p.title as placeTitle,
            m.id as writer,
            m.email as writerEmail,
            r.title as title,
            r.content as content,
            r.img_url as imgUrl,
            r.rate as rate,
            n.id as updatedPerson,
            r.created_at as createdAt,
            r.modified_at as updatedAt
        from rev r
                 join place p on r.place_no = p.no
                 join mem m on r.writer_email = m.email
                 join mem n on r.modified_by = n.email
        where r.no = #{no}
    </select>

    <insert id="insertReview" parameterType="ReviewReqDto">
        insert into rev
        (title, content, rate, writer_email, place_no, img_url, modified_by)
        values
        (#{title}, #{content}, #{rate}, #{writerEmail}, #{placeNo}, #{imgUrl}, #{modifiedBy})
    </insert>

    <update id="updateReview" parameterType="ReviewReqDto">
        update rev
        set
            title = #{title},
            content = #{content},
            modified_by = #{modifiedBy},
            img_url = #{imgUrl},
            rate = #{rate}
        where no = #{no}
    </update>

    <delete id="deleteReview" parameterType="int">
        delete
        from rev
        where no = #{no}
    </delete>

    <select id="findReviewByMemberId" resultType="ReviewResDTO">
        select
            r.no as no,
            p.title as placeTitle,
            m.id as writer,
            m.email as writerEmail,
            r.title as title,
            r.content as content,
            r.rate as rate,
            r.created_at as createdAt,
            r.img_url as imgUrl,
            r.modified_at as updatedAt
        from rev r
            join place p on r.place_no = p.no
            join mem m on r.writer_email = m.email
        where r.writer_email = #{memberNo}
        order by r.no
    </select>

    <select id="findReviewByPlaceId" resultType="ReviewResDTO">
        select
            r.no as no,
            p.title as placeTitle,
            m.id as writer,
            m.email as writerEmail,
            r.title as title,
            r.content as content,
            r.img_url as imgUrl,
            r.rate as rate,
            r.created_at as createdAt,
            r.modified_at as updatedAt
        from rev r
            join place p on r.place_no = p.no
            join mem m on r.writer_email = m.email
        where r.place_no = #{placeNo}
        order by r.no desc
    </select>

    <select id="selectReviewListWithPaging" resultType="ReviewResDto">
        select
        no,
        title,
        content,
        rate,
        writer_email as writerEmail
        from rev
        where place_no = #{placeNo}
        order by no
        LIMIT #{selectCriteria.startRow}, #{selectCriteria.limit}
    </select>

    <select id="countReview" resultType="int">
        select count(*)
        from rev
        where place_no = #{placeNo}
    </select>

    <select id="findTopRatedPlaceAgg"
            parameterType="int"
            resultType="com.multi.multi_semi.main_list.rating.dto.TopRatedPlaceDto">

        SELECT
            p.no           AS placeNo,
            p.title        AS placeTitle,
            SUM(r.rate)    AS rateSum,
            COUNT(*)       AS rateCount,
            MAX(r.img_url) AS imgUrl
        FROM rev r
                 JOIN place p ON r.place_no = p.no
        GROUP BY p.no, p.title
        HAVING COUNT(*) > 0
        ORDER BY (SUM(r.rate) * 1.0 / COUNT(*)) DESC
            LIMIT #{limit}
    </select>

    <select id="findPlaceRatingAgg"
            parameterType="long"
            resultType="com.multi.multi_semi.main_list.rating.dto.TopRatedPlaceDto">

        SELECT
            p.no           AS placeNo,
            p.title        AS placeTitle,
            SUM(r.rate)    AS rateSum,
            COUNT(*)       AS rateCount,
            MAX(r.img_url) AS imgUrl
        FROM rev r
                 JOIN place p ON r.place_no = p.no
        WHERE p.no = #{placeNo}
        GROUP BY p.no, p.title
    </select>

</mapper>